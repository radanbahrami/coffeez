{% extends "coffeez/base.html" %}

{% block title %}Donation Status{% endblock %}

{% block extra_head %}
<meta name="robots" content="noindex, nofollow">
{% endblock %}

{% block content %}
<div class="donation-status-container">
    {% if pending %}
        <div id="pending-card" class="donation-status-card donation-pending">
            <div class="status-icon">
                <i data-lucide="clock"></i>
            </div>
            <h2>Send Your Donation</h2>
            <p style="margin-bottom: -0.5rem;">Send <b>exactly this amount</b> to complete your donation:</p>
            <div class="wallet-info">
                <div class="amount">{{ exact_amount }} TRX</div>
                <div class="address-section">
                    <p>Wallet Address:</p>
                    <div class="transaction-id-container">
                        <input type="text" 
                               value="{{ creator.wallet_address }}" 
                               readonly 
                               id="wallet-address"
                               data-original-wallet="{{ purchase.creator_wallet_address }}">
                        <button type="button" onclick="copyWalletAddress()" title="Copy wallet address" class="glass-btn">
                            <i data-lucide="copy"></i>
                        </button>
                    </div>
                    <p style="color: var(--error); margin-top: 0.7em;">
                        <b>Warning:</b> Only send TRX using the <b>TRON network (TRC20)</b>.<br>
                        Sending TRX from other networks (like Ethereum or Binance Smart Chain) will result in lost funds and cannot be recovered.<br>
                        Carefully review the address before sending.
                    </p>
                </div>
            </div>
            <p>Waiting for your transaction...</p>
            <div style="text-align: center; margin: 1rem 0;">
                <small style="color: var(--text-muted);">
                    Need help sending TRX? <a href="/guides/supporting/" style="color: var(--accent); text-decoration: underline;">Check our step-by-step guide</a>
                </small>
            </div>
            <div id="timer-container" style="margin: 2rem auto; text-align: center;">
                <span id="timer-label" style="font-size: 1.1rem; color: var(--text-muted);">Time left to complete your donation:</span>
                <div id="timer" style="font-size: 2rem; font-weight: bold; color: var(--error); margin-top: 0.5rem;"></div>
            </div>
            <p>This page should refresh automatically every 30 seconds to check for your transaction.<br>If it doesn't, <a href="{% url 'check_donation' purchase.id %}">click here</a>.</p>
        </div>
        <div id="expired-card" class="donation-status-card donation-expired" style="display:none;">
            <div class="status-icon">
                <i data-lucide="alert-triangle"></i>
            </div>
            <h2 style="color: var(--error); margin-bottom: 1rem;">Donation Time Expired</h2>
            <p style="color: var(--error); font-size: 1.1rem;">The time to complete your donation has expired.<br>Please start a new donation.</p>
            <p style="color: var(--error); font-size: 1.1rem;"><b>Warning: </b><b>DO NOT</b> send any payment now - this request has expired and won't be processed.</p>
            <div style="text-align: center; margin-top: 1.5rem;">
                <small style="color: var(--text-muted);">
                    Need help with crypto donations? <a href="/guides/supporting/" style="color: var(--accent); text-decoration: underline;">Read our support guide</a>
                </small>
            </div>
        </div>
        <script>
            function copyTransactionId() {
                const element = document.getElementById('transaction-id');
                element.select();
                element.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(element.value).then(() => {
                    const button = element.parentElement.querySelector('button');
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<i data-lucide="check"></i>';
                    button.style.backgroundColor = '#22c55e';
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                        button.style.backgroundColor = '';
                        lucide.createIcons();
                    }, 2000);
                    lucide.createIcons();
                });
            }

            function copyWalletAddress() {
                const element = document.getElementById('wallet-address');
                element.select();
                element.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(element.value).then(() => {
                    const button = element.parentElement.querySelector('button');
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<i data-lucide="check"></i>';
                    button.style.backgroundColor = '#22c55e';
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                        button.style.backgroundColor = '';
                        lucide.createIcons();
                    }, 2000);
                    lucide.createIcons();
                });
            }

            const TIMER_DURATION = 1800; // 30 minutes
            const CHECK_INTERVAL = 30000; // Check every 30 seconds
            const purchaseId = "{{ purchase.id|default:'0' }}";
            const timerKey = "coffeez_timer_" + purchaseId;
            const expiredKey = "coffeez_expired_" + purchaseId;
            const timerEl = document.getElementById('timer');
            const expiredCardEl = document.getElementById('expired-card');
            const pendingCardEl = document.getElementById('pending-card');
            const timerContainer = document.getElementById('timer-container');

            // Set up periodic check for donation status
            let checkInterval;

            function startPeriodicCheck() {
                checkInterval = setInterval(() => {
                    // Only check if not expired
                    if (localStorage.getItem(expiredKey) !== "1") {
                        window.location.href = "{% url 'check_donation' purchase.id %}";
                    }
                }, CHECK_INTERVAL);
            }

            function stopPeriodicCheck() {
                if (checkInterval) {
                    clearInterval(checkInterval);
                    checkInterval = null;
                }
            }

            function showExpired() {
                timerContainer.style.display = "none";
                pendingCardEl.style.display = "none";
                expiredCardEl.style.display = "block";
                // Mark as permanently expired
                localStorage.setItem(expiredKey, "1");
                // Stop checking for donations
                stopPeriodicCheck();
            }

            function startOrResumeTimer() {
                // If expired flag is set, show expired card immediately
                if (localStorage.getItem(expiredKey) === "1") {
                    showExpired();
                    return;
                }

                let startTime = localStorage.getItem(timerKey);
                if (!startTime) {
                    startTime = Date.now();
                    localStorage.setItem(timerKey, startTime);
                } else {
                    startTime = parseInt(startTime, 10);
                    // Check if timer already expired based on stored start time
                    const now = Date.now();
                    const elapsed = Math.floor((now - startTime) / 1000);
                    if (elapsed >= TIMER_DURATION) {
                        showExpired();
                        return;
                    }
                }
                
                updateTimer(startTime);
                // Start periodic checking for donations
                startPeriodicCheck();
            }

            function updateTimer(startTime) {
                function pad(n) { return n < 10 ? '0' + n : n; }

                let timerInterval;

                function getTimerColor(remaining) {
                    // >10 min: green, 10-5 min: orange, <5 min: red
                    if (remaining > 600) {
                        return '#22c55e'; // green
                    } else if (remaining > 300) {
                        return '#f59e42'; // orange
                    } else {
                        return 'var(--error)'; // red
                    }
                }

                function tick() {
                    const now = Date.now();
                    const elapsed = Math.floor((now - startTime) / 1000);
                    const remaining = TIMER_DURATION - elapsed;

                    if (remaining > 0) {
                        const min = Math.floor(remaining / 60);
                        const sec = remaining % 60;
                        timerEl.textContent = `${pad(min)}:${pad(sec)}`;
                        timerEl.style.color = getTimerColor(remaining);
                    } else {
                        timerEl.textContent = "00:00";
                        timerEl.style.color = 'var(--error)';
                        if (timerInterval) {
                            clearInterval(timerInterval);
                        }
                        showExpired();
                        return; // Stop the interval
                    }
                }

                // Initial tick
                tick();

                // Set up interval
                timerInterval = setInterval(tick, 1000);
            }

            document.addEventListener('DOMContentLoaded', function() {
                startOrResumeTimer();
            });

            // Clean up intervals when page is about to unload
            window.addEventListener('beforeunload', function() {
                stopPeriodicCheck();
            });
        </script>
    {% elif success %}
        <div class="donation-status-card donation-success">
            <div class="status-icon">
                <i data-lucide="check-circle"></i>
            </div>
            <h2>Thank You!</h2>
            <p>Your donation was received successfully!</p>
            <div class="transaction-section">
                <p>Transaction ID:</p>
                <div class="transaction-id-container">
                    <input type="text" 
                           value="{{ purchase.transaction_id }}" 
                           readonly 
                           id="transaction-id">
                    <button type="button" onclick="copyTransactionId()" title="Copy transaction ID" class="glass-btn">
                        <i data-lucide="copy"></i>
                    </button>
                </div>
            </div>
        </div>
        <script>
            function copyTransactionId() {
                const element = document.getElementById('transaction-id');
                element.select();
                element.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(element.value).then(() => {
                    const button = element.parentElement.querySelector('button');
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<i data-lucide="check"></i>';
                    button.style.backgroundColor = '#22c55e';
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                        button.style.backgroundColor = '';
                        lucide.createIcons();
                    }, 2000);
                    lucide.createIcons();
                });
            }
        </script>
    {% else %}
        <div class="donation-status-card donation-waiting">
            <div class="status-icon">
                <i data-lucide="clock"></i>
            </div>
            <h2>Still Waiting for Your Donation...</h2>
            <p>If you have sent the transaction, please wait a moment for confirmation.</p>
            <script>
                setTimeout(() => {
                    window.location.href = "{% url 'check_donation' purchase.id %}";
                }, 30000);
            </script>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script>
    lucide.createIcons();
    
    // Wallet address validation function (regex from server-side validator)
    function isValidWalletAddress(address) {
        return /^T[a-zA-Z0-9]{33}$/.test(address);
    }
    
    // Function to check if wallet address matches original address
    function checkWalletAddress() {
        const walletInput = document.getElementById('wallet-address');
        
        if (walletInput) {
            const currentWallet = walletInput.value;
            const originalWallet = walletInput.dataset.originalWallet;
            
            // Check if wallet address is valid
            if (!isValidWalletAddress(currentWallet)) {
                displayError("Invalid wallet address format. Please contact support.");
                return false;
            }
            
            // Check if wallet address matches the original one
            if (originalWallet && currentWallet !== originalWallet) {
                displayError("Wallet address has changed since donation was initiated. For security, this donation cannot proceed.");
                return false;
            }
        }
        
        return true;
    }
    
    function displayError(message) {
        const pendingCard = document.getElementById('pending-card');
        
        if (pendingCard) {
            // Create error div
            const errorDiv = document.createElement('div');
            errorDiv.className = 'donation-status-card donation-error';
            errorDiv.innerHTML = `
                <div class="status-icon">
                    <i data-lucide="alert-circle"></i>
                </div>
                <h2 style="color: var(--error);">Wallet Address Error</h2>
                <p>${message}</p>
                <p>Please <a href="/contact">contact support</a> for assistance.</p>
            `;
            
            // Replace pending card with error
            pendingCard.parentNode.replaceChild(errorDiv, pendingCard);
            lucide.createIcons();
            
            // Stop the timer and checks
            stopPeriodicCheck();
            if (typeof timerInterval !== 'undefined') {
                clearInterval(timerInterval);
            }
        }
    }
    
    // Run validation on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkWalletAddress();
    });
</script>
{% endblock %}
